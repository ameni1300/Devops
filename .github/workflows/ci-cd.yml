name: CI/CD Pipeline

on:
  push:
    branches: [ feature/currency-api, main ]
  pull_request:
    branches: [ main ]

jobs:
  # JOB 1: Tests de l'application
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Test API startup
        run: |
          cd src
          python -c "import app; print('âœ… API imports successfully')"

  # JOB 2: SÃ©curitÃ© SAST
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: SAST with Bandit
        run: |
          pip install bandit
          bandit -r src/ -ll || echo "Bandit scan completed"

  # JOB 3: Build Docker
  build-docker:
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image
        run: |
          docker build -t currency-api:latest .
      
      - name: Verify Docker image
        run: |
          docker images | grep currency-api

  # JOB 4: SÃ©curitÃ© DAST (NOUVEAU)
  security-dast:
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image for testing
        run: |
          docker build -t currency-api:test .
      
      - name: Start API container
        run: |
          docker run -d -p 5000:5000 --name api-test currency-api:test
          echo "ğŸ”„ Waiting for API to start..."
          sleep 10
      
      - name: Test API health endpoint
        run: |
          echo "ğŸ§ª Testing health endpoint..."
          curl -f http://localhost:5000/health
          echo "âœ… Health check passed"
      
      - name: Test API conversion endpoint
        run: |
          echo "ğŸ§ª Testing conversion endpoint..."
          curl -f "http://localhost:5000/convert?from=EUR&to=USD&amount=100"
          echo "âœ… Conversion endpoint works"
      
      - name: Test API metrics endpoint
        run: |
          echo "ğŸ§ª Testing metrics endpoint..."
          curl -f http://localhost:5000/metrics
          echo "âœ… Metrics endpoint works"
      
      - name: Test with invalid parameters
        run: |
          echo "ğŸ§ª Testing error handling..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/convert?from=INVALID&to=USD&amount=100")
          if [ "$response" -eq 400 ] || [ "$response" -eq 500 ]; then
            echo "âœ… Error handling works (got status: $response)"
          else
            echo "âŒ Unexpected response: $response"
            exit 1
          fi
      
      - name: Cleanup containers
        run: |
          docker stop api-test || true
          docker rm api-test || true
        if: always()
      # JOB 5: Validation Kubernetes (VERSION SIMPLIFIÃ‰E)
  validate-kubernetes:
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate Kubernetes manifests
        run: |
          echo "ğŸ” Validating Kubernetes manifests..."
          
          # VÃ©rifier que les fichiers existent
          echo "ğŸ“ Kubernetes files:"
          ls -la k8s/
          
          # VÃ©rifier la structure basique sans Python
          echo "ğŸ“‹ Checking Kubernetes structure..."
          
          # VÃ©rifier deployment.yaml
          if grep -q "apiVersion: apps/v1" k8s/deployment.yaml && \
             grep -q "kind: Deployment" k8s/deployment.yaml && \
             grep -q "replicas: 2" k8s/deployment.yaml; then
            echo "âœ… deployment.yaml - Valid"
          else
            echo "âŒ deployment.yaml - Invalid"
            exit 1
          fi
          
          # VÃ©rifier service.yaml
          if grep -q "apiVersion: v1" k8s/service.yaml && \
             grep -q "kind: Service" k8s/service.yaml; then
            echo "âœ… service.yaml - Valid"
          else
            echo "âŒ service.yaml - Invalid"
            exit 1
          fi
          
          # VÃ©rifier namespace.yaml
          if grep -q "apiVersion: v1" k8s/namespace.yaml && \
             grep -q "kind: Namespace" k8s/namespace.yaml; then
            echo "âœ… namespace.yaml - Valid"
          else
            echo "âŒ namespace.yaml - Invalid"
            exit 1
          fi
          
          echo "ğŸ‰ All Kubernetes manifests are valid!"