name: CI/CD Pipeline

on:
  push:
    branches: [ feature/currency-api, main ]
  pull_request:
    branches: [ main ]

jobs:
  # JOB 1: Tests de l'application
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Test API startup
        run: |
          cd src
          python -c "import app; print('‚úÖ API imports successfully')"

  # JOB 2: S√©curit√© SAST
  security:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: SAST with Bandit
        run: |
          pip install bandit
          bandit -r src/ -ll || echo "Bandit scan completed"

  # JOB 3: Build Docker
  build-docker:
    runs-on: ubuntu-latest
    needs: [test, security]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image
        run: |
          docker build -t currency-api:latest .
      
      - name: Verify Docker image
        run: |
          docker images | grep currency-api

  # JOB 4: S√©curit√© DAST (NOUVEAU)
  security-dast:
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Build Docker image for testing
        run: |
          docker build -t currency-api:test .
      
      - name: Start API container
        run: |
          docker run -d -p 5000:5000 --name api-test currency-api:test
          echo "üîÑ Waiting for API to start..."
          sleep 10
      
      - name: Test API health endpoint
        run: |
          echo "üß™ Testing health endpoint..."
          curl -f http://localhost:5000/health
          echo "‚úÖ Health check passed"
      
      - name: Test API conversion endpoint
        run: |
          echo "üß™ Testing conversion endpoint..."
          curl -f "http://localhost:5000/convert?from=EUR&to=USD&amount=100"
          echo "‚úÖ Conversion endpoint works"
      
      - name: Test API metrics endpoint
        run: |
          echo "üß™ Testing metrics endpoint..."
          curl -f http://localhost:5000/metrics
          echo "‚úÖ Metrics endpoint works"
      
      - name: Test with invalid parameters
        run: |
          echo "üß™ Testing error handling..."
          response=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:5000/convert?from=INVALID&to=USD&amount=100")
          if [ "$response" -eq 400 ] || [ "$response" -eq 500 ]; then
            echo "‚úÖ Error handling works (got status: $response)"
          else
            echo "‚ùå Unexpected response: $response"
            exit 1
          fi
      
      - name: Cleanup containers
        run: |
          docker stop api-test || true
          docker rm api-test || true
        if: always()
      # JOB 5: Validation Kubernetes (VERSION SIMPLIFI√âE)
  validate-kubernetes:
    runs-on: ubuntu-latest
    needs: build-docker
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Validate Kubernetes manifests
        run: |
          echo "üîç Validating Kubernetes manifests..."
          
          # V√©rifier que les fichiers existent
          echo "üìÅ Kubernetes files:"
          ls -la k8s/
          
          # V√©rifier la structure basique sans Python
          echo "üìã Checking Kubernetes structure..."
          
          # V√©rifier deployment.yaml
          if grep -q "apiVersion: apps/v1" k8s/deployment.yaml && \
             grep -q "kind: Deployment" k8s/deployment.yaml && \
             grep -q "replicas: 2" k8s/deployment.yaml; then
            echo "‚úÖ deployment.yaml - Valid"
          else
            echo "‚ùå deployment.yaml - Invalid"
            exit 1
          fi
          
          # V√©rifier service.yaml
          if grep -q "apiVersion: v1" k8s/service.yaml && \
             grep -q "kind: Service" k8s/service.yaml; then
            echo "‚úÖ service.yaml - Valid"
          else
            echo "‚ùå service.yaml - Invalid"
            exit 1
          fi
          
          # V√©rifier namespace.yaml
          if grep -q "apiVersion: v1" k8s/namespace.yaml && \
             grep -q "kind: Namespace" k8s/namespace.yaml; then
            echo "‚úÖ namespace.yaml - Valid"
          else
            echo "‚ùå namespace.yaml - Invalid"
            exit 1
          fi
          
          echo "üéâ All Kubernetes manifests are valid!"

            # JOB 6: Push to Docker Hub (NOUVEAU)
  push-dockerhub:
    runs-on: ubuntu-latest
    needs: [test, security, build-docker]
    
    # Only push on main branch or tags
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature/currency-api' || startsWith(github.ref, 'refs/tags/')    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/currency-api
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/currency-api:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max